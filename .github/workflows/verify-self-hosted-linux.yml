name: Verify Self-Hosted Linux Runner
on:
  workflow_dispatch:

jobs:
  verify-environment:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg for LiveCap
        run: |
          echo "Setting up FFmpeg in ./ffmpeg-bin..."
          mkdir -p ffmpeg-bin
          
          # Locate system ffmpeg
          FFMPEG_PATH=$(which ffmpeg)
          FFPROBE_PATH=$(which ffprobe)
          
          if [ -z "$FFMPEG_PATH" ]; then
            echo "FFmpeg not found! Downloading portable binary..."
            
            # Use ffbinaries (static build) to avoid sudo/apt-get
            FFBIN_URL="https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v6.1/ffmpeg-6.1-linux-64.zip"
            curl -L -o ffmpeg.zip "$FFBIN_URL"
            
            unzip -o ffmpeg.zip
            chmod +x ffmpeg ffprobe
            
            mv ffmpeg ffmpeg-bin/
            # ffbinaries zips often contain ffprobe as well or separate, let's check.
            # Actually ffbinaries splits them sometimes. Let's use a simpler approach or check contents.
            # For v6.1 linux-64, it seems they are often separate or combined.
            # Let's just download both if needed or check what we got.
            # Re-reading suggestions: "wget .../ffmpeg-6.1-linux-64.zip". 
            # Official ffbinaries usually has them separate or combined. 
            # Let's assume for now we grab ffmpeg and check ffprobe.
            # If ffprobe is missing in that zip, we might need another download.
            # Actually, let's use the "johnvansickle" builds (static) or similar if ffbinaries is complex.
            # But the review suggested ffbinaries. Let's try to be robust.
            
            # Better approach for consistency: Use a known static build URL that has both or just ffmpeg.
            # Let's stick to the reviewer suggestion of ffbinaries but ensure we get both if possible.
            # Checking ffbinaries repo structure... often separate zips.
            # Reviewer example: "unzip ffmpeg-6.1-linux-64.zip -d ffmpeg-bin/"
            
            # Let's verify if we need ffprobe. Yes we do.
            # Let's try to get both.
            
            # Download ffmpeg
            curl -L -o ffmpeg.zip "https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v6.1/ffmpeg-6.1-linux-64.zip"
            unzip -o ffmpeg.zip -d temp_ffmpeg
            mv temp_ffmpeg/ffmpeg ffmpeg-bin/
            
            # Download ffprobe
            curl -L -o ffprobe.zip "https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v6.1/ffprobe-6.1-linux-64.zip"
            unzip -o ffprobe.zip -d temp_ffprobe
            mv temp_ffprobe/ffprobe ffmpeg-bin/
            
            rm ffmpeg.zip ffprobe.zip
            rm -rf temp_ffmpeg temp_ffprobe
            
            chmod +x ffmpeg-bin/ffmpeg ffmpeg-bin/ffprobe
            
            # Set paths for the log output below
            FFMPEG_PATH="ffmpeg-bin/ffmpeg"
            FFPROBE_PATH="ffmpeg-bin/ffprobe"
          else
              echo "Copying from $FFMPEG_PATH and $FFPROBE_PATH"
              cp "$FFMPEG_PATH" ffmpeg-bin/
              cp "$FFPROBE_PATH" ffmpeg-bin/
          fi
          
          echo "Listing ffmpeg-bin:"
          ls -l ffmpeg-bin/

      - name: Verify FFmpeg Resolution via ENV
        env:
          LIVECAP_FFMPEG_BIN: ${{ github.workspace }}/ffmpeg-bin
        run: |
          echo "Testing FFmpeg resolution with LIVECAP_FFMPEG_BIN=$LIVECAP_FFMPEG_BIN"
          
          # Simulate how the app finds the binary
          if [ -f "$LIVECAP_FFMPEG_BIN/ffmpeg" ]; then
            echo "SUCCESS: Found ffmpeg binary at expected path."
            "$LIVECAP_FFMPEG_BIN/ffmpeg" -version | head -n 1
          else
            echo "FAILURE: ffmpeg binary not found in LIVECAP_FFMPEG_BIN location."
            exit 1
          fi

      - name: Check Other Tools
        run: |
          echo "=== Tool Versions ==="
          echo "Python: $(python3 --version 2>&1 || echo 'Not found')"
          
          # Check for uv
          if ! command -v uv &> /dev/null; then
               if [ -f "$HOME/.cargo/bin/uv" ]; then export PATH="$HOME/.cargo/bin:$PATH"; fi
          fi
          echo "uv: $(uv --version 2>&1 || echo 'Not found')"
